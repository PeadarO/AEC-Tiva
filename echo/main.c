#include <stdbool.h>
#include <stdint.h>
#include <stdlib.h>
#include "inc/hw_memmap.h"
#include "driverlib/adc.h"
#include "driverlib/gpio.h"
#include "driverlib/pin_map.h"
#include "driverlib/sysctl.h"
#include "driverlib/uart.h"
#include "utils/uartstdio.h"

//this lookuptable represents a whitenoise which will be added to the sinus signal to later be removed bei the NLMS algorithm
static const float noise[200] =
{
 1.462949324, -0.514108359, 1.257462596, 0.502248682, -0.32059818,
 -0.094397485, -2.138424195, 0.833845428, -1.551133492, -0.755722742,
 -1.691643793, -0.807766739, -0.023146504, 1.565711122, -0.174973996,
 0.673354216, 0.326325634, 0.437461209, 1.122702691, 0.276127631,
 0.643507874, -0.446606589, -0.067111827, 0.944864796, -0.726271351,
 0.555295486, 1.277235535, 1.063157282, -0.342148471, 1.657754814,
 1.517837376, -0.211174003, -0.265974855, 0.19410509, -2.759546048,
 0.182573851, 0.113071618, 0.346391006, -0.306041801, 0.79267599,
 2.629357548, 1.068721582, 0.074588219, 0.718616191, 0.771338738,
 0.320331677, -0.795864829, -0.518641688, -1.20604795, -0.046496929,
 -0.734925753, 1.031738341, -1.332292148, 0.427649698, 1.595227441,
 -0.486529554, 0.073341313, -0.986213446, 1.141743599, -0.743026195,
 -0.168949387, -0.323200703, -0.881937727, -0.182687304, 1.218540507,
 -1.059018357, 2.707061884, -0.146630654, 0.55235901, 0.576229269,
 -0.284699206, 0.574394182, -0.132856851, 0.79438425, -1.272196055,
 -0.153905699, -0.650156593, 0.123488736, -1.395803107, -0.419947432,
 1.43144581, -0.051187313, 0.467250082, 0.097251671, 0.338177939,
 -1.216654739, -0.266553874, -1.210770217, -1.450017601, -2.604811078,
 -0.124026169, -1.034940335, -0.232057461, -0.079433677, 2.433694154,
 0.126396512, 0.929057845, 1.029368468, 2.633290633, 1.132101335,
 -0.830886274, 0.550438647, 0.000569589, 0.235369145, 1.338699949,
 -0.687109862, -0.581721117, 0.845455435, 1.170973195, -0.598692058,
 0.608483419, -1.24854251, 1.353412594, 2.087697011, -0.884039508,
 1.785254603, 0.011939017, -1.463258485, -0.717738759, -1.010269474,
 0.553857646, 1.105500079, -1.29605311, -0.626069213, 1.615616281,
 -0.518912428, -0.033993595, 0.441182335, -0.385900976, 0.072739473,
 0.979450842, -2.13691443, 0.705941097, 2.110418899, -1.240247354,
 -0.941629065, -1.026563388, -0.680327842, -0.828463124, -1.074273015,
 0.140911764, 1.940334955, -1.309216649, -0.897908761, -0.442854919,
 1.595690485, -0.010165444, -0.054252963, -0.246395064, 0.617486246,
 -0.81061225, -1.192888769, -0.792667461, -0.318931704, -0.953240533,
 -0.69523827, 0.057800528, 0.163916718, -0.162495123, -0.810616143,
 -0.480373272, -0.617869452, -1.765767452, 1.470979696, 1.56725105,
 1.907813597, 0.269866651, -2.155962284, -1.853203015, 0.107572633,
 0.935332846, 0.220717006, -0.976334844, 0.189389334, 1.124758966,
 0.401145394, 0.676002696, -1.590739607, 0.081790402, 1.248089398,
 -0.831868628, 0.487599982, -1.050476444, 1.279015317, -0.616721499,
 -0.225555548, -0.65576675, -0.802641546, -0.253648981, -0.289522337,
 1.261235095, -0.959941844, -0.368133225, -1.202815306, -1.255901616,
 -1.465169382, 1.885521638, -0.005019102, -0.327288037, -0.579294847
};

//this lookuptable represents a 440Hz Sinus when using a 8kHz Samplesize
static const float sinus[200] =
{
     -1, -0.940880769, -0.770513243, -0.509041416, -0.187381315,
     0.156434465, 0.481753674, 0.75011107, 0.929776486, 0.99950656,
     0.951056516, 0.790155012, 0.535826795, 0.218143241, -0.125333234,
     -0.4539905, -0.728968627, -0.917754626, -0.998026728, -0.960293686,
     -0.809016994, -0.562083378, -0.248689887, 0.094108313, 0.425779292,
     0.707106781, 0.904827052, 0.995561965, 0.968583161, 0.827080574,
     0.587785252, 0.278991106, -0.06279052, -0.397147891, -0.684547106,
     -0.891006524, -0.992114701, -0.975916762, -0.844327926, -0.612907054,
     -0.309016994, 0.031410759, 0.368124553, 0.661311865, 0.87630668,
     0.987688341, 0.982287251, 0.860742027, 0.63742399, 0.33873792,
     -2.2056E-15, -0.33873792, -0.63742399, -0.860742027, -0.982287251,
     -0.987688341, -0.87630668, -0.661311865, -0.368124553, -0.031410759,
     0.309016994, 0.612907054, 0.844327926, 0.975916762, 0.992114701,
     0.891006524, 0.684547106, 0.397147891, 0.06279052, -0.278991106,
     -0.587785252, -0.827080574, -0.968583161, -0.995561965, -0.904827052,
     -0.707106781, -0.425779292, -0.094108313, 0.248689887, 0.562083378,
     0.809016994, 0.960293686, 0.998026728, 0.917754626, 0.728968627,
     0.4539905, 0.125333234, -0.218143241, -0.535826795, -0.790155012,
     -0.951056516, -0.99950656, -0.929776486, -0.75011107, -0.481753674,
     -0.156434465, 0.187381315, 0.509041416, 0.770513243, 0.940880769,
     1, 0.940880769, 0.770513243, 0.509041416, 0.187381315,
     -0.156434465, -0.481753674, -0.75011107, -0.929776486, -0.99950656,
     -0.951056516, -0.790155012, -0.535826795, -0.218143241, 0.125333234,
     0.4539905, 0.728968627, 0.917754626, 0.998026728, 0.960293686,
     0.809016994, 0.562083378, 0.248689887, -0.094108313, -0.425779292,
     -0.707106781, -0.904827052, -0.995561965, -0.968583161, -0.827080574,
     -0.587785252, -0.278991106, 0.06279052, 0.397147891, 0.684547106,
     0.891006524, 0.992114701, 0.975916762, 0.844327926, 0.612907054,
     0.309016994, -0.031410759, -0.368124553, -0.661311865, -0.87630668,
     -0.987688341, -0.982287251, -0.860742027, -0.63742399, -0.33873792,
     4.4112E-15, 0.33873792, 0.63742399, 0.860742027, 0.982287251,
     0.987688341, 0.87630668, 0.661311865, 0.368124553, 0.031410759,
     -0.309016994, -0.612907054, -0.844327926, -0.975916762, -0.992114701,
     -0.891006524, -0.684547106, -0.397147891, -0.06279052, 0.278991106,
     0.587785252, 0.827080574, 0.968583161, 0.995561965, 0.904827052,
     0.707106781, 0.425779292, 0.094108313, -0.248689887, -0.562083378,
     -0.809016994, -0.960293686, -0.998026728, -0.917754626, -0.728968627,
     -0.4539905, -0.125333234, 0.218143241, 0.535826795, 0.790155012,
     0.951056516, 0.99950656, 0.929776486, 0.75011107, 0.481753674,
     0.156434465, -0.187381315, -0.509041416, -0.770513243, -0.940880769
};

//variables that are used in the function
float stepsize = 0.0005; //dynamic stepsize is recalculated every time removeEcho is called
float filterWeight = 0.0; //filter weights are recaluclated every time removeEcho is called
static float alfa = 0.0008; //constant that alters the speed and the accuracy of the NLMS algorithm
static float constant = 0.001; // constant to prevent larger steps and division by zero

void cancelEcho(const float *mic, const float *farend, float *out)
{
    float y = 0.0;

    float down = constant + (*farend * *farend);
    stepsize = alfa/down;

    y = filterWeight * *farend;

    *out = *mic - y;

    filterWeight = filterWeight + stepsize * *out * *farend;
}

void InitConsole(void)
{
    SysCtlPeripheralEnable(SYSCTL_PERIPH_GPIOA);
    GPIOPinConfigure(GPIO_PA0_U0RX);
    GPIOPinConfigure(GPIO_PA1_U0TX);
    SysCtlPeripheralEnable(SYSCTL_PERIPH_UART0);
    UARTClockSourceSet(UART0_BASE, UART_CLOCK_PIOSC);
    GPIOPinTypeUART(GPIO_PORTA_BASE, GPIO_PIN_0 | GPIO_PIN_1);
    UARTStdioConfig(0, 115200, 16000000);
}

int main(void)
{
    uint32_t ui32SysClock;
    float output;
    float micSignal;
    uint16_t i,j;
    long transfer;

    ui32SysClock = SysCtlClockFreqSet(SYSCTL_XTAL_25MHZ | SYSCTL_USE_PLL | SYSCTL_CFG_VCO_480, 16*1000*1000);

    InitConsole();
    UARTprintf("ADC ->\n");
    UARTprintf("  Type: Single Ended\n");
    UARTprintf("  Samples: One\n");
    UARTprintf("  Update Rate: 250ms\n");
    UARTprintf("  Input Pin: AIN0/PE3\n\n");

    while(1)
    {
        for(j = 0; j < 40; j++)
        {
            for(i = 0; i < 200; i++)
            {
                micSignal = sinus[i] + noise[i];
                cancelEcho(&micSignal, &noise[i], &output);
                transfer = (int)(output * 100000000);
                UARTprintf("%d\n", transfer);
                if(i == 199)
                {
                    i = i;
                }
            }
        }

        while(1){}
    }
}
